{% extends 'navbar.html' %}
{% load static %}

{% block title %} Main Page {% endblock %}

{% block link %}
    <script src="{% static 'js/hw.js' %}"></script>
    <link href="{% static 'styles/style_hw.css' %}?version=21" rel="stylesheet">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
{% endblock %}
{% block content %}
    <p align="center">It finally works!!!!!!</p>

    {% for homework in homeworks %}
    <div class = "Homework_show">
        <div class="Homework_profile">
            <div class="Homework_profile_user">
                <img src="{{homework.publisher_profile.photo.url}}" 
                height="50px" width="50px" style="float: left;">
                <p style="float: left; margin-left: 10px; transform: translate(0, 50%)">{{homework.publisher.username}}</p>
            </div>
            <p style="right: 0%; float: right; transform: translate(0, 50%)">Опубликовано:{{homework.uploaded}}</p>
        </div>
        <div class="Homework_img">
            {% for image in homework.images.all %}
            <p align="center"><img src="{{image.image.url}}" width="700px" style="text-align: center"></p>
            {% endfor %}
        </div>
        <div class="Homework_buttons" id="hw_buttons{{homework.id}}" data-hwid="{{homework.id}}">
            <div class="Homework_like">
                <button id="like_button" onclick="likeHW(this)" type="button" data-hwid="{{homework.id}}" style="border: 0; background: transparent; width: 54px; padding: 0px">
                    <img src="{% static 'images/like_btn.png' %}" class="like_img" height="50px" style="float: left;">
                </button>
                <div class="Homework_like_count" id="like_count{{homework.id}}">{{ homework.likes.count }}</div>
            </div>
            <div class="Homework_dislike">
                <button id="dislike_button" onclick="dislikeHW(this)" type="button" data-hwid="{{homework.id}}" style="border: 0; background: transparent; width: 54px; padding: 0px">
                    <img src="{% static 'images/dislike_btn.png' %}" class="dislike_img" height="50px" style="float: left;">
                </button>
                <div class="Homework_dislike_count" id="dislike_count{{homework.id}}">{{homework.dislikes.count }}</div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endblock %}

{% block script %}
<script>
window.onload = function() {
    var hwButtons = document.getElementsByClassName("Homework_buttons");
    for (let btns of hwButtons) {
        let hwid = $(btns).attr("data-hwid");
        let imgLike = $(btns).find('.like_img');
        let imgDislike = $(btns).find('.dislike_img');
        $.ajax({
            type: "GET",
            url: "{% url 'get_opinion' %}",
            dataType: "JSON",
            data: {homework_id: hwid},
            success: function(json) {
                if (json.liked) {
                    $(imgLike).attr("src", "{% static 'images/like_btn_liked.png' %}")
                }
                else {
                    $(imgLike).attr("src", "{% static 'images/like_btn.png' %}")
                }
                if (json.disliked) {
                    $(imgDislike).attr("src", "{% static 'images/dislike_btn_disliked.png' %}")
                }
                else {
                    $(imgDislike).attr("src", "{% static 'images/dislike_btn.png' %}")
                }
            }
        })
    }
}

function likeHW (btn) {
    var hwid = $(btn).attr("data-hwid");
    var div = $('#hw_buttons'+hwid);
    $.ajax({
        type: "GET",
        url: "{% url 'like_hw' %}",
        dataType: "JSON",
        data: {homework_id: hwid},
        success: function(json) {
            div.find('.Homework_like_count').html(json.likes);
            div.find('.Homework_dislike_count').html(json.dislikes);
            var imgLike = div.find('.like_img');
            var imgDislike = div.find('.dislike_img');
            if (json.liked) {
                $(imgLike).attr("src", "{% static 'images/like_btn_liked.png' %}");
                if (json.undisliked) {
                    $(imgDislike).attr("src", "{% static 'images/dislike_btn.png' %}");
                }
            }
            else {
                $(imgLike).attr("src", "{% static 'images/like_btn.png' %}");
            }
        }
    })
}
function dislikeHW (btn) {
    var hwid = $(btn).attr("data-hwid");
    var div = $('#hw_buttons'+hwid);
    $.ajax({
        type: "GET",
        url: "{% url 'dislike_hw' %}",
        dataType: "JSON",
        data: {homework_id: hwid},
        success: function(json) {
            div.find('.Homework_like_count').html(json.likes);
            div.find('.Homework_dislike_count').html(json.dislikes);
            var imgLike = div.find('.like_img');
            var imgDislike = div.find('.dislike_img');
            if (json.disliked) {
                $(imgDislike).attr("src", "{% static 'images/dislike_btn_disliked.png' %}");
                if (json.unliked) {
                    $(imgLike).attr("src", "{% static 'images/like_btn.png' %}");
                }
            }
            else {
                $(imgDislike).attr("src", "{% static 'images/dislike_btn.png' %}");
            }
        }
    })
}
</script>
{% endblock %}