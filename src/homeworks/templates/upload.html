{% extends 'navbar.html' %}
{% load static %}
{% block link %}
    <link href="{% static 'styles/upload_style.css' %}?version=6" rel="stylesheet">
{% endblock %}
{% block title %} Выложить домашку {% endblock %}
{% block content %}
    <div class ="upload_upload">
        <div class="go_back">
            <img id="go_back_img" src="{% static 'images/go_back.png' %}" alt="ГРУЗИСЬ БЛЯТЬ">
        </div>
        <form id="post-form" enctype="multipart/form-data" method="post" action="{% url 'upload' %}">
            {% csrf_token %}
            <div class="div_input" id="div_input_grade">
                <select name="grade" id="grade_select" class="input_hw">
                    <option hidden disabled selected value="not chosen">-- Выберите класс --</option>
                    <option value="http://127.0.0.1:8000/api/grades/2/">10</option>
                </select>
            </div>
            <div class="div_input invis" id="div_input_subject">
                <select name="subject" id="subject_select" class="input_hw">
                    <option hidden disabled selected value="not chosen">-- Выберите предмет --</option>
                </select>
            </div>
            <div class="div_input invis" id="div_input_book">
                <select name="book" id="book_select" class="input_hw">
                    <option hidden disabled selected value="not chosen">-- Выберите книгу --</option>
                </select>
            </div>
            <div class="div_input invis" id="div_input_number">
                <select name="number" id="number_select" class="input_hw">
                    <option hidden disabled selected value="not chosen">-- Выберите номер --</option>
                </select>
            </div>
            <div class="div_input invis" id="file_input">
                <div id="uploads"></div>
                <div class="dropzone" id="dropzone">Перетащите файлы</div>
            </div>
            <div class="upload_btn invis" id="upload_btn">
                <button type="submit" value="upload_hw" class="upload-button">Выложить</button>
            </div>
        </form>
    </div>
{% endblock %}
{% block script %}
<script>
function get_object(url) {
    var instance = [];
    $.ajax({
        url: url,
        async: false,
        success: (json) => {instance = json}
    })
    return instance
}

function get_choices(list) {
    return list.map(url => {
        let obj = get_object(url);
        return {"value":obj.url, "fullname":obj.full_name}
    })
}

function create_hw(form, uploadedFiles) {
    formdata = new FormData(form);
    data = new FormData(form);
    formdata.forEach((value, key) => {
        if (key == "grade") {
            data.delete(key);
            data.append(key, get_object(value).grade);
        }
        else if (key == "subject" || key == "book") {
            data.delete(key);
            data.append(key, get_object(value).name);
        }
    })
    uploadedFiles.forEach(function(file, i) {
        console.log(i, file);
        data.append("file"+i, file);
    })
    // data.forEach((value, key) => console.log(value, key))
    $.ajax({
        url: "{% url 'upload' %}",
        type: "POST",
        contentType: false,
        processData: false,
        cache: false,
        data: data,
        success: function(json) {
            if (json.created) {
                console.log("YEAAAAAH!!");
            }
            else {
                console.log(json.error);
            }
        }
    })

}
window.onload = function() {
    var grades = get_object('/api/grades/')
    var grade = $('#div_input_grade');
    var grade_select = grade.find('.input_hw');
    var subject = $('#div_input_subject');
    var subject_select = subject.find('.input_hw');
    var book = $('#div_input_book');
    var book_select = book.find('.input_hw');
    var number = $('#div_input_number');
    var number_select = number.find('.input_hw');
    var file = $('#file_input');
    var btn = $('#upload_btn');
    var dropzone = $('#dropzone');
    var uploadedFiles = [];
    var grade = 10
    var currentChoices = ["10"]
    var jsonBooks = null;
    var jsonNumbers = null;

    $('#post-form').on('submit', function(e) {
        e.preventDefault()
        console.log("submitted");
        grade_select.attr("disabled", false)
        subject_select.attr("disabled", false);
        book_select.attr("disabled", false);
        number_select.attr("disabled", false);
        create_hw(this, uploadedFiles);
    })


    dropzone.on("dragover", function() {
        $(this).addClass('dragover');
        return false;
    })

    dropzone.on("dragleave", function() {
        $(this).removeClass('dragover');
    })

    dropzone.on("drop", function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        e.dataTransfer = e.originalEvent.dataTransfer;
        Array.from(e.dataTransfer.files).forEach(function(file){
            if (file.name.split('.').pop() != "png") {
                alert("Файл должен быть с расширением .png");
            }
            else {
                if (uploadedFiles.length == 0) {
                    btn.removeClass('invis');
                }
                uploadedFiles.push(file);
                $('#uploads').append('<h5 class="names">'+file.name+'</h5>');
                $('#uploads h5:last').on("click", function() {
                    for (let i = 0; i < uploadedFiles.length; i++) {
                        if (uploadedFiles[i].name == $(this).text()) {
                            uploadedFiles.splice(i, 1);
                            break;
                        }
                    }
                    $(this).remove();
                    if (uploadedFiles.length == 0) {
                        btn.addClass('invis');
                    }
                })
            }
        })
    })

    $('#go_back_img').on('click', function() {
        if (grade_select.attr("disabled") && !subject_select.attr("disabled")) {
            grade_select.attr("disabled", false);
            grade_select.attr("value", 'not chosen');
            subject.addClass("invis");
            subject_select.empty()
            subject_select.append(
            '<option hidden disabled selected value="not chosen">-- Выберите предмет --</option>'
            )
        }
        if (subject_select.attr("disabled") && !book_select.attr("disabled")){
            subject_select.attr("disabled", false);
            subject_select.attr("value", 'not chosen');
            book.addClass("invis");
            book_select.empty()
            book_select.append(
            '<option hidden disabled selected value="not chosen">-- Выберите книгу --</option>'
            )
        }
        else if (book_select.attr("disabled") && !number_select.attr("disabled")){
            book_select.attr("disabled", false);
            book_select.attr("value", 'not chosen');
            number.addClass("invis");
            number_select.empty()
            number_select.append(
            '<option hidden disabled selected value="not chosen">-- Выберите параграф --</option>'
            )
        }
        else if (number_select.attr("disabled")) {
            number_select.attr("disabled", false);
            number_select.attr("value", 'not chosen');
            file.addClass("invis");
            if (!btn.hasClass("invis")) {
                btn.addClass("invis");
            }
            uploadedFiles = [];
            $('#uploads').empty();
        }
    })

    grade_select.on('change', function() {
        currentChoices = get_choices(get_object(this.value).subjects);
        currentChoices.forEach((subject => {
            subject_select.append('<option value="'+subject.value+'">'+subject.fullname+'</option')
        }));
        subject.removeClass("invis");
        grade_select.attr("disabled", true);
    })

    subject_select.on('change', function() {
        currentChoices = get_choices(get_object(this.value).books);
        currentChoices.forEach(function(book) {
            book_select.append('<option value="'+book.value+'">'+book.fullname+'</option>');
        })
        book.removeClass("invis");
        subject_select.attr("disabled", true);
    })

    book_select.on('change', function() {
        currentChoices = JSON.parse(get_object(this.value).number_list)
        currentChoices.forEach(number => {
            number_select.append('<option value="'+number+'">'+number+'</option');
        })
        number.removeClass("invis");
        book_select.attr("disabled", true);
    })

    number_select.on('change', function() {
        file.removeClass("invis");
        number_select.attr("disabled", true);
    })
}
</script>
{% endblock %}